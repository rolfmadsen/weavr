# Feature Specification: Local Auto-Save & Desktop Experience

**Status**: Proposed
**Last Updated**: 2025-12-09

## 1\. Overview

This feature introduces a "native-like" file management experience to Weavr. It enables users to open and save Event Models directly to their local computer's file system using the **File System Access API**. It also includes a configured **Progressive Web App (PWA)** implementation, allowing the application to be installed, run offline, and function indistinguishably from a native desktop application. This ensures data persistence even if the browser cache is cleared.

## 2\. Goals & Non-Goals

  * **Goals**:

      * **Local Persistence**: Enable reading/writing of `.json` model files directly to the user's hard drive.
      * **Auto-Save**: Automatically persist changes to the open local file in the background without user intervention.
      * **Desktop Experience**: Provide "Open", "Save", and "Save As" functionality that mimics native software.
      * **Offline Capability**: Ensure the app shells load and function completely offline via PWA Service Workers.
      * **Compatibility**: Ensure these features run in parallel with the existing GunJS real-time collaboration engine.

  * **Non-Goals**:

      * Cloud storage providers (Google Drive/Dropbox API integration) are out of scope; strictly local file system for now.
      * Simultaneous multi-user editing of the *same local file* (Collaboration happens via GunJS relays, the file is a user-specific snapshot).

## 3\. User Stories

  * **As a** User, **I want to** open a project file from my "Documents" folder, **so that** I can resume work on a specific model I stored previously.
  * **As a** User, **I want** Weavr to auto-save my changes to the file on disk, **so that** I don't lose work if my browser crashes or cache is cleared.
  * **As a** User, **I want to** install Weavr as an app on my computer, **so that** I can launch it quickly without navigating browser tabs and URLs.
  * **As a** User, **I want to** use "Save As" to create a backup copy of my model, **so that** I can experiment on a new branch of work.

## 4\. Technical Design

### 4.1. Data Model

The file format remains the standard Weavr JSON export structure managed by `exportUtils.ts`.
The internal hook will utilize the following interface for tracking state to save:

```typescript
interface AutoSaveData {
    nodes: Node[];
    links: Link[];
    slices: Slice[];
    definitions: DataDefinition[];
    modelId: string;
    projectName: string;
}
```

### 4.2. Architecture / Components

**A. New Hook: `useLocalFileAutoSave.ts`**

  * **Responsibility**: Manages the `FileSystemFileHandle`, tracks "dirty" state, and executes the write operations.
  * **Logic**:
      * Uses `window.showSaveFilePicker` and `window.showOpenFilePicker`.
      * Implements a debouncer (approx. 2000ms) to trigger saves after user inactivity.
      * Uses `exportWeavrProject` to generate the JSON blob.

**B. PWA Configuration**

  * **Manifest**: `manifest.json` added to `public/` to define app name, icons, and `display: standalone`.
  * **Service Worker**: A basic SW configuration (likely via Vite PWA plugin) to cache the app shell (HTML/CSS/JS) for offline access.

**C. Integration Point**

  * The `Workspace` component (or `App.tsx`) will instantiate `useLocalFileAutoSave`, passing in the live data from `useGraphSync`.
  * It will expose UI controls for "Open File" and "Enable Local Save".

### 4.3. API / Interface

**Hook Signature:**

```typescript
function useLocalFileAutoSave(data: AutoSaveData): {
    connectFile: () => Promise<void>; // Triggers 'Save As' / File Picker
    openFile: () => Promise<void>;    // Triggers 'Open' Picker
    fileHandle: FileSystemFileHandle | null;
    lastSaved: Date | null;
    isSaving: boolean;
    error: string | null;
}
```

**Browser APIs Used:**

  * `window.showSaveFilePicker(options)`
  * `window.showOpenFilePicker(options)`
  * `FileSystemFileHandle.createWritable()`

## 5\. Verification Plan

  * [ ] **PWA Install**: Verify the "Install" icon appears in the browser address bar and the app launches in a standalone window.
  * [ ] **Offline Load**: Turn off WiFi/Ethernet and verify the PWA launches and loads the canvas successfully.
  * [ ] **File Connection**: Click "Save/Connect", select a location, and verify a `.json` file is created.
  * [ ] **Auto-Save**: Make a change (add a node), wait 2 seconds, and verify the file modification timestamp updates on the OS.
  * [ ] **Browser Cache Clear**: Clear all browser data (LocalStorage/IndexedDB), reload, use "Open File", and verify the model is restored perfectly.
  * [ ] **GunJS Coexistence**: Verify that while connected to a file, dragging nodes still updates connected peers in real-time.

## 6\. Open Questions

  * [ ] **Permission Persistence**: Browsers often require re-granting file permission on page reload. Can we store the handle in IndexedDB to verify permissions more gracefully?
  * [ ] **Mobile Support**: The File System Access API is not fully supported on all mobile browsers. Should we hide these buttons on mobile or offer a fallback "Download" button?